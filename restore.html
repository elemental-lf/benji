

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Restore &mdash; Benji Backup 0.7.0.dev77+g1111276 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
        <script type="text/javascript" src="_static/asciinema/asciinema-player.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/asciinema/asciinema-player.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Retention Policy Enforcement" href="enforce.html" />
    <link rel="prev" title="Scrub" href="scrub.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Benji Backup
          

          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="installation.html#fedora-27-and-up">Fedora 27 and up</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#opensuse">openSUSE</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#rhel-centos-7">RHEL/CentOS 7</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#ubuntu-16-04">Ubuntu 16.04</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#common-to-all-distributions">Common to All Distributions</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#ceph-rbd-support">Ceph RBD Support</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quick Start</a><ul>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#some-vocabulary">Some Vocabulary</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#backup">Backup</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#deep-scrub-and-scrub">Deep Scrub and Scrub</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#restore">Restore</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#version-removal-and-cleanup">Version Removal and Cleanup</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Configuration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#configuration-file-location">Configuration File Location</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#top-level-configuration-directives">Top-level configuration directives</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#list-of-i-o-configurations">List of I/O Configurations</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#list-of-transform-configurations">List of Transform Configurations</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#list-of-storage-configurations">List of Storage Configurations</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#i-o-modules">I/O Modules</a><ul>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#i-o-module-file">I/O Module file</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#i-o-module-rbd">I/O Module rbd</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#i-o-module-rbdaio">I/O Module rbdaio</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#i-o-module-iscsi">I/O Module iscsi</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#transform-modules">Transform Modules</a><ul>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#transform-module-zstd">Transform Module zstd</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#transform-module-aes-256-gcm">Transform Module aes_256_gcm</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#storage-modules">Storage Modules</a><ul>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#hmac">HMAC</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#read-cache">Read Cache</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#storage-module-file">Storage Module file</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#storage-module-s3">Storage Module s3</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#storage-module-b2">Storage Module b2</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#nbd">NBD</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#multiple-instance-installations">Multiple Instance Installations</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="backup.html">Backup</a><ul>
<li class="toctree-l2"><a class="reference internal" href="backup.html#simple-backup">Simple Backup</a></li>
<li class="toctree-l2"><a class="reference internal" href="backup.html#versions">Versions</a></li>
<li class="toctree-l2"><a class="reference internal" href="backup.html#differential-backup">Differential Backup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="backup.html#examples">Examples</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="backup.html#specifying-a-block-size">Specifying a block size</a></li>
<li class="toctree-l2"><a class="reference internal" href="backup.html#labeling-versions">Labeling <em>Versions</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="backup.html#the-hints-file">The Hints File</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="scrub.html">Scrub</a><ul>
<li class="toctree-l2"><a class="reference internal" href="scrub.html#reasons-for-scrubbing">Reasons for Scrubbing</a></li>
<li class="toctree-l2"><a class="reference internal" href="scrub.html#scrubbing-methods">Scrubbing Methods</a><ul>
<li class="toctree-l3"><a class="reference internal" href="scrub.html#consistency-and-checksum">Consistency and Checksum</a></li>
<li class="toctree-l3"><a class="reference internal" href="scrub.html#using-the-backup-source">Using the Backup Source</a></li>
<li class="toctree-l3"><a class="reference internal" href="scrub.html#consistency-only">Consistency Only</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="scrub.html#batch-scrubbing">Batch scrubbing</a></li>
<li class="toctree-l2"><a class="reference internal" href="scrub.html#scrubbing-failures">Scrubbing Failures</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Restore</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#restoring">Restoring</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#restoring-without-a-database">Restoring without a database</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#nbd-server">NBD Server</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#read-only-mount">Read-Only Mount</a></li>
<li class="toctree-l3"><a class="reference internal" href="#read-write-mount">Read-Write Mount</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#restoring-invalid-versions">Restoring Invalid <em>Versions</em></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="enforce.html">Retention Policy Enforcement</a><ul>
<li class="toctree-l2"><a class="reference internal" href="enforce.html#policy-specification">Policy Specification</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="cleanup.html">Cleanup</a><ul>
<li class="toctree-l2"><a class="reference internal" href="cleanup.html#removing-old-versions">Removing old versions</a></li>
<li class="toctree-l2"><a class="reference internal" href="cleanup.html#id1">Cleanup</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="administration.html">Administration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="administration.html#securing-version-metadata">Securing Version Metadata</a><ul>
<li class="toctree-l3"><a class="reference internal" href="administration.html#backups-and-exports">Backups and Exports</a></li>
<li class="toctree-l3"><a class="reference internal" href="administration.html#database-high-availability">Database High-Availability</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="administration.html#securing-block-data-on-storages">Securing Block Data on Storages</a></li>
<li class="toctree-l2"><a class="reference internal" href="administration.html#monitoring">Monitoring</a><ul>
<li class="toctree-l3"><a class="reference internal" href="administration.html#general-advise">General Advise</a></li>
<li class="toctree-l3"><a class="reference internal" href="administration.html#machine-output">Machine output</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="container.html">Containerized Benji</a><ul>
<li class="toctree-l2"><a class="reference internal" href="container.html#images">Images</a><ul>
<li class="toctree-l3"><a class="reference internal" href="container.html#benji">benji</a></li>
<li class="toctree-l3"><a class="reference internal" href="container.html#benji-k8s">benji-k8s</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="container.html#helm-charts">Helm Charts</a><ul>
<li class="toctree-l3"><a class="reference internal" href="container.html#id1">benji-k8s</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="filter_expressions.html">Filter Expressions</a></li>
<li class="toctree-l1"><a class="reference internal" href="datalayout.html">Data Layout</a><ul>
<li class="toctree-l2"><a class="reference internal" href="datalayout.html#database-backend">Database Backend</a></li>
<li class="toctree-l2"><a class="reference internal" href="datalayout.html#block-storages">Block Storages</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="backy2.html">For Backy² Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="support.html">Support</a><ul>
<li class="toctree-l2"><a class="reference internal" href="support.html#issue-tracker">Issue Tracker</a></li>
<li class="toctree-l2"><a class="reference internal" href="support.html#documentation">Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="support.html#security">Security</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="licenses.html">Licenses</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Benji Backup</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Restore</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/restore.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="restore">
<span id="id1"></span><h1>Restore<a class="headerlink" href="#restore" title="Permalink to this headline">¶</a></h1>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>$ benji restore --help
usage: benji restore [-h] [-s] [-f] [-d] [-S STORAGE] version_uid destination

positional arguments:
  version_uid           Version UID to restore
  destination           Destination URL

optional arguments:
  -h, --help            show this help message and exit
  -s, --sparse          Restore only existing blocks
  -f, --force           Overwrite an existing file, device or image
  -d, --database-less   Restore without requiring the database
  -S STORAGE, --storage STORAGE
                        Source storage (if unspecified the default is used)
</pre></div>
</div>
<p>There are two possible restore options with Benji.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you determined the <em>version</em> you want to restore it is a good idea to protect this <em>version</em> with
<code class="docutils literal notranslate"><span class="pre">benji</span> <span class="pre">protect</span></code> to prevent any accidental or automatic removal by any retention policy enforcement that you
might have configured.</p>
</div>
<div class="section" id="restoring">
<h2>Restoring<a class="headerlink" href="#restoring" title="Permalink to this headline">¶</a></h2>
<p>A restore can write a <em>version</em> to any one of the supported and configured I/O instances. This doesn’t have to be
the same I/O instance that was used for creating the backup. The URL syntax is the same as the one used for the
backup command. Examples include:</p>
<ul>
<li><p>Command line: <code class="docutils literal notranslate"><span class="pre">benji</span> <span class="pre">restore</span> <span class="pre">--sparse</span> <span class="pre">V00000001</span> <span class="pre">example-1:///tmp/vm1-image.qcow2</span></code></p>
<p>I/O module configuration:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ios:
  - name: example-1
    module: file
</pre></div>
</div>
<p>Restores <em>version</em> <code class="docutils literal notranslate"><span class="pre">V00000001</span></code> to path <code class="docutils literal notranslate"><span class="pre">/tmp/vm1-image.qcow2</span></code> in the local filesystem</p>
</li>
<li><p>Command line: <code class="docutils literal notranslate"><span class="pre">benji</span> <span class="pre">restore</span> <span class="pre">--sparse</span> <span class="pre">V00000002</span> <span class="pre">example-2:pool-1/image-2</span></code></p>
<p>I/O module configuration:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ios:
  - name: example-2
    module: rbdaio
    configuration:
      newImageFeatures:
        - RBD_FEATURE_LAYERING
</pre></div>
</div>
<p>Restores <em>version</em> <code class="docutils literal notranslate"><span class="pre">V00000002</span></code> to an RBD image named <code class="docutils literal notranslate"><span class="pre">image-2</span></code> in the Ceph pool <code class="docutils literal notranslate"><span class="pre">pool-1</span></code>. The RBD image is
created in the process with the configured RBD image features. If no RBD image features are specified in the
configuration Ceph’s default is used.</p>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Normally the name chosen for an instance of the <code class="docutils literal notranslate"><span class="pre">file</span></code> module is <code class="docutils literal notranslate"><span class="pre">file</span></code> and the name used for an instance
of an <code class="docutils literal notranslate"><span class="pre">rbd</span></code> or <code class="docutils literal notranslate"><span class="pre">rbdaio</span></code> module is <code class="docutils literal notranslate"><span class="pre">rbd</span></code>. But that is not required and there can be multiple instances of the
same I/O module with different configurations under different names.</p>
</div>
<p>If the target already exists, i.e.</p>
<ul class="simple">
<li><p>it is a device file</p></li>
<li><p>an existing Ceph RBD volume</p></li>
<li><p>or an existing image file</p></li>
</ul>
<p>the <code class="docutils literal notranslate"><span class="pre">--force</span></code>  option needs to be added to the command line. Otherwise Benji won’t overwrite the existing resource.</p>
<p>Generally the usage of the <code class="docutils literal notranslate"><span class="pre">--sparse</span></code> option is advisable to skip the restore of sparse (empty) blocks. This
increases restore performance and also decreases space usage in most cases. When <code class="docutils literal notranslate"><span class="pre">--sparse</span></code> is not specified
sparse blocks are written as blocks of zeros.</p>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>If you use <code class="docutils literal notranslate"><span class="pre">--sparse</span></code> to restore to an existing device or file, sparse blocks will not be written,
so whatever random data was in the location of the sparse block before the restore will remain. This is not
the case with Ceph RBD as <code class="docutils literal notranslate"><span class="pre">--sparse</span></code> will discard all currently used blocks before beginning the restore.</p>
</div>
<div class="section" id="restoring-without-a-database">
<span id="database-less-restore"></span><h3>Restoring without a database<a class="headerlink" href="#restoring-without-a-database" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">benji</span> <span class="pre">restore</span></code> also supports a mode to restore a <em>version</em> even when the database is not available. This
mode is activated by passing the <code class="docutils literal notranslate"><span class="pre">--database-less</span></code> switch to <code class="docutils literal notranslate"><span class="pre">benji</span> <span class="pre">restore</span></code>. Benji will import the
metadata backup of the specified <em>version</em> from the storage into an ad-hoc in-memory database and then restore the
image normally. If you have configured more than one storage location and the <em>version</em> to restore does not reside
on the default storage you need to specify the storage location with <code class="docutils literal notranslate"><span class="pre">--storage</span></code>.</p>
<p>This mode is for failure scenarios where the database is unavailable. But because of this unavailability it is
impossible to execute commands like <code class="docutils literal notranslate"><span class="pre">benji</span> <span class="pre">ls</span></code> to determine the right <em>version</em>  for the restore. Reports
(based on <code class="docutils literal notranslate"><span class="pre">benji</span> <span class="pre">ls</span></code>) need to be generated and saved beforehand so that this information is still available in another
way.</p>
</div>
</div>
<div class="section" id="nbd-server">
<h2>NBD Server<a class="headerlink" href="#nbd-server" title="Permalink to this headline">¶</a></h2>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>$ benji nbd --help
usage: benji nbd [-h] [-a BIND_ADDRESS] [-p BIND_PORT] [-r]

optional arguments:
  -h, --help            show this help message and exit
  -a BIND_ADDRESS, --bind-address BIND_ADDRESS
                        Bind to the specified IP address (default: 127.0.0.1)
  -p BIND_PORT, --bind-port BIND_PORT
                        Bind to the specified port (default: 10809)
  -r, --read-only       NBD device is read-only (default: False)
</pre></div>
</div>
<p>Benji comes with its own NBD server which when started exports all known <em>versions</em>. These <em>versions</em> can then be
mounted on any Linux host. The requirements on the Linux host are:</p>
<ul class="simple">
<li><p>loaded <code class="docutils literal notranslate"><span class="pre">nbd</span></code> kernel module (<code class="docutils literal notranslate"><span class="pre">modprobe</span> <span class="pre">nbd</span></code> as root)</p></li>
<li><p>installed <code class="docutils literal notranslate"><span class="pre">nbd-client</span></code> program (RPM package <code class="docutils literal notranslate"><span class="pre">nbd</span></code> on RHEL/CentOS7/Fedora)</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">nbd-client</span></code> contacts Benji’s NBD server and connects an exported <em>version</em> to am NBD block device (<code class="docutils literal notranslate"><span class="pre">/dev/nbd*</span></code>)
on the Linux host. If the image contains a filesystem it can be mounted normally. You can then search for the relevant
files and restore them.</p>
<p>There are some known issues with <code class="docutils literal notranslate"><span class="pre">nbd-client</span></code>:</p>
<ul class="simple">
<li><p>Some problems have been reported with <code class="docutils literal notranslate"><span class="pre">nbd-client</span></code> 3.18. Please see <a class="reference external" href="https://github.com/elemental-lf/benji/issues/12">https://github.com/elemental-lf/benji/issues/12</a>.
Older versions like 3.16 and 3.17 (needs <code class="docutils literal notranslate"><span class="pre">-t</span></code>, see below) and newer versions like 3.19 seems to be fine.</p></li>
<li><p>Debian 10 (“Buster”) has an <cite>nbd-client</cite> package with version 3.19-3. The binary reports 3.18 as its version for
whatever reason. This version does not work with Benji at all. See <a class="reference external" href="https://github.com/elemental-lf/benji/issues/56">https://github.com/elemental-lf/benji/issues/56</a>.
Currently (10/08/2019) the development version of Debian contains a newer <cite>nbd-client</cite> package which works without
problems. This version will hopefully propagate into testing and then into Buster.</p></li>
<li><p>Some versions of <code class="docutils literal notranslate"><span class="pre">nbd-client</span></code> (like 3.17) use a timeout value of zero which also leads to problems. Please
explicitly specify a timeout with <code class="docutils literal notranslate"><span class="pre">-t</span></code> in these cases. To make the confusion complete some distributions have
back-ported the fix for this issue. So 3.17 on Fedora is actually fine without <code class="docutils literal notranslate"><span class="pre">-t</span></code>.</p></li>
<li><p>If the image has a partition table the Linux kernel will have problems parsing the partition table
when the device block size used by <code class="docutils literal notranslate"><span class="pre">nbd-client</span></code> is different from the one used during creation of the partition
table. Please use the <code class="docutils literal notranslate"><span class="pre">-b</span></code> option of <code class="docutils literal notranslate"><span class="pre">nbd-client</span></code> to specify the original device block size which normally
will be 512. Newer versions of <code class="docutils literal notranslate"><span class="pre">nbd-client</span></code> already changed the default block size from 1024 to 512 because of
this. See <a class="reference external" href="https://github.com/NetworkBlockDevice/nbd/commit/128fd556286ff5d53c5f2b16c4ae5746b5268a64">https://github.com/NetworkBlockDevice/nbd/commit/128fd556286ff5d53c5f2b16c4ae5746b5268a64</a>.</p></li>
</ul>
<div class="section" id="read-only-mount">
<h3>Read-Only Mount<a class="headerlink" href="#read-only-mount" title="Permalink to this headline">¶</a></h3>
<p>This command will run the NBD server in read-only mode and wait for incoming connections:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ benji nbd -r
    INFO: Starting to serve nbd on <span class="m">127</span>.0.0.1:10809
</pre></div>
</div>
<p>Benji’s NBD server will serve all available <em>versions</em> and it is possible to access each one of them as a block device
by using <code class="docutils literal notranslate"><span class="pre">nbd-client</span></code> und the in-kernel <code class="docutils literal notranslate"><span class="pre">nbd</span></code> driver:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load the nbd kernel module</span>
$ sudo modprobe nbd

<span class="c1"># Connect a Benji version to a free NBD block device</span>
$ sudo nbd-client -N V0000000001 <span class="m">127</span>.0.0.1 -p <span class="m">10809</span> -b <span class="m">512</span> -t <span class="m">10</span> /dev/nbd0
Negotiation: ..size <span class="o">=</span> 10MB
<span class="nv">bs</span><span class="o">=</span><span class="m">512</span>, <span class="nv">sz</span><span class="o">=</span><span class="m">10485760</span> bytes

<span class="c1"># Detect partitions</span>
<span class="c1"># (partprobe might throw a few WARNINGs because we&#39;re read-only)</span>
partprobe /dev/nbd0

<span class="c1"># Mount the filesystem</span>
mount -o ro /dev/nbd0p1 /mnt
</pre></div>
</div>
<p>If the image just contains a filesystem without a partition table the <code class="docutils literal notranslate"><span class="pre">partprobe</span></code> command can be skipped and
the <code class="docutils literal notranslate"><span class="pre">/dev/nbd0</span></code> device can be mounted directly. Some filesystem will require additional mount options as they try
to write to the device even when <code class="docutils literal notranslate"><span class="pre">ro</span></code> is specified.</p>
<p>The NBD server will signal an incoming connection:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span> INFO: Incoming connection from <span class="m">127</span>.0.0.1:33714
DEBUG: <span class="o">[</span><span class="m">127</span>.0.0.1:33714<span class="o">]</span>: <span class="nv">opt</span><span class="o">=</span><span class="m">7</span>, <span class="nv">len</span><span class="o">=</span><span class="m">17</span>, <span class="nv">data</span><span class="o">=</span>b<span class="s1">&#39;\x00\x00\x00\x0bV0000000001\x00\x00&#39;</span>
DEBUG: <span class="o">[</span><span class="m">127</span>.0.0.1:33714<span class="o">]</span>: <span class="nv">opt</span><span class="o">=</span><span class="m">1</span>, <span class="nv">len</span><span class="o">=</span><span class="m">11</span>, <span class="nv">data</span><span class="o">=</span>b<span class="s1">&#39;V0000000001&#39;</span>
 INFO: <span class="o">[</span><span class="m">127</span>.0.0.1:33714<span class="o">]</span> Negotiated export: V0000000001
 INFO: nbd is <span class="nb">read</span> only.
</pre></div>
</div>
<p>After you’re done using the filesystem you need to unmount it and disconnect the NBD device:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>umount /mnt
nbd-client -d /dev/nbd0
</pre></div>
</div>
<p>You can then either reconnect to this or another <em>version</em> or terminate Benji’s NBD server. The server is also able to
serve multiple <em>versions</em> at once.</p>
<p>Benji’s NBD server by default listens on 127.0.0.1 (i.e. localhost) for incoming connections. For the server to be
reachable from the outside bind it to 0.0.0.0 or the specific address of another interface:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>benji nbd -a <span class="m">0</span>.0.0.0 -r
</pre></div>
</div>
</div>
<div class="section" id="read-write-mount">
<h3>Read-Write Mount<a class="headerlink" href="#read-write-mount" title="Permalink to this headline">¶</a></h3>
<p>In addition to providing read-only access, Benji also allows read-write access in a safe way. This means, the original
<em>version</em> <strong>will not be modified</strong>. To access the available <em>versions</em> in read-write mode start the NBD server
without the <code class="docutils literal notranslate"><span class="pre">-r</span></code> option.</p>
<p>After connecting the NBD device you can initiate any repair procedures required like <code class="docutils literal notranslate"><span class="pre">fsck</span></code>.  Any writes to the
device will initiate a copy-on-write (COW) of the original blocks to a new <em>version</em> which is dynamically created
by Benji.</p>
<p>After disconnecting the NBD device Benji will start to fixate the COW <em>version</em>. Depending on how many changes
have been done to the original <em>version</em> this will take some time!:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>INFO: <span class="o">[</span><span class="m">127</span>.0.0.1:46526<span class="o">]</span> disconnecting
INFO: Fixating version V0000000002 with <span class="m">1024</span> blocks, please wait!
INFO: Fixation <span class="k">done</span>. Deleting temporary data, please wait!
INFO: Finished.
</pre></div>
</div>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>If you end the NBD server before the last “INFO: Finished.” is reported, your copy-on-write clone will not
be written completely and thus be incomplete. However, the original backup <em>version</em>
<strong>will be untouched in any case</strong>.</p>
</div>
<p>The newly created <em>version</em> can be seen in the output of <code class="docutils literal notranslate"><span class="pre">benji</span> <span class="pre">ls</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ benji ls
    INFO: $ benji ls
+---------------------+-------------+------+-----------------------------------------+----------+------------+-------+-----------+------+
<span class="p">|</span>         date        <span class="p">|</span>     uid     <span class="p">|</span> name <span class="p">|</span> snapshot                                <span class="p">|</span>     size <span class="p">|</span> block_size <span class="p">|</span> valid <span class="p">|</span> protected <span class="p">|</span> tags <span class="p">|</span>
+---------------------+-------------+------+-----------------------------------------+----------+------------+-------+-----------+------+
<span class="p">|</span> <span class="m">2018</span>-06-10T01:00:43 <span class="p">|</span> V0000000001 <span class="p">|</span> <span class="nb">test</span> <span class="p">|</span>                                         <span class="p">|</span> <span class="m">41943040</span> <span class="p">|</span>    <span class="m">4194304</span> <span class="p">|</span>  True <span class="p">|</span>   False   <span class="p">|</span>      <span class="p">|</span>
<span class="p">|</span> <span class="m">2018</span>-06-10T01:01:16 <span class="p">|</span> V0000000002 <span class="p">|</span> <span class="nb">test</span> <span class="p">|</span> nbd-cow-V0000000001-2018-06-10T01:01:16 <span class="p">|</span> <span class="m">41943040</span> <span class="p">|</span>    <span class="m">4194304</span> <span class="p">|</span>  True <span class="p">|</span>    True   <span class="p">|</span>      <span class="p">|</span>
+---------------------+-------------+------+-----------------------------------------+----------+------------+-------+-----------+------+
</pre></div>
</div>
<p>The name will be the same as the original <em>version</em>. The snapshot will start with the prefix <em>nbd-cow-</em> followed by the
<em>version</em> UID followed by a timestamp.</p>
<p>The COW <em>version</em> will automatically be marked as protected by Benji to prevent removal by any automatic retention
policy enforcement configured. This ensures the new <em>version</em> won’t be destroyed accidentally. To be able to remove
the <em>version</em> the protection needs to be lifted with <code class="docutils literal notranslate"><span class="pre">benji</span> <span class="pre">unprotect</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The new created COW <em>version</em> can be restored just like any other <em>version</em>. Both the original and the
COW <em>version</em> are independent from each other and each can be removed without affecting the other.</p>
</div>
</div>
</div>
<div class="section" id="restoring-invalid-versions">
<h2>Restoring Invalid <em>Versions</em><a class="headerlink" href="#restoring-invalid-versions" title="Permalink to this headline">¶</a></h2>
<p>During a restore Benji will compare each restored block’s checksum to the one stored in the database.
This even happens when the block has been marked as invalid previously. If it encounters a difference, the block
and all <em>versions</em> also referencing this block will be marked as invalid and a warning will be given:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ERROR: Checksum mismatch during restore <span class="k">for</span> block <span class="m">9</span> <span class="o">(</span>UID <span class="m">1</span>-a<span class="o">)</span> <span class="o">(</span>is: e36cee7fd34ae637... should-be: dea186672147e1e3..., block.valid: True<span class="o">)</span>. Block restored is invalid.
 INFO: Marked block invalid <span class="o">(</span>UID <span class="m">1</span>-a, Checksum dea186672147e1e3. Affected versions: V0000000001, V0000000002
 INFO: Marked version invalid <span class="o">(</span>UID V0000000001<span class="o">)</span>
 INFO: Marked version invalid <span class="o">(</span>UID V0000000002<span class="o">)</span>
</pre></div>
</div>
<p>Even when encountering such an error, Benji will continue the restore.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The philosophy behind this is that restores should always succeed, even if there
is data corruption. Often invalid data is in irrelevant places or can be fixed later.
You get as much of your data back as possible!</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="enforce.html" class="btn btn-neutral float-right" title="Retention Policy Enforcement" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="scrub.html" class="btn btn-neutral float-left" title="Scrub" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017-2019, Lars Fenneberg, Daniel Kraft

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
  
 


</body>
</html>